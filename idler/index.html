<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Island Idler</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üèùÔ∏è</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #87CEEB 0%, #98D8C8 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1400px;
            width: 100%;
            padding: 40px;
            display: flex;
            flex-direction: column;
        }

        .top-section {
            display: flex;
            justify-content: flex-end;
            gap: 20px;
            margin-bottom: 20px;
        }

        .right-sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 240px;
            max-width: 240px;
        }

        .middle-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: flex-start;
        }

        .shop-section-wrapper {
            flex: 0 0 auto;
        }

        .main-header {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFE8B3 100%);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 0 0 auto;
            width: 240px;
        }

        .header {
            text-align: center;
        }

        h1 {
            color: #F7B32B;
            font-size: 1.8em;
            margin-bottom: 10px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .stats {
            text-align: center;
            margin-bottom: 20px;
        }

        .bell-count {
            font-size: 1.6em;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .per-second {
            font-size: 0.85em;
            color: #666;
        }

        .total-production {
            font-size: 0.8em;
            color: #6BAA5E;
            margin-top: 8px;
            font-weight: 600;
        }

        .fish-message {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            border-left: 4px solid #2196F3;
            padding: 10px 12px;
            margin-top: 8px;
            border-radius: 6px;
            font-size: 0.85em;
            color: #1565C0;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .fish-message strong {
            color: #0D47A1;
            font-size: 1em;
        }

        .fish-message .fish-details {
            margin-top: 5px;
            font-size: 0.85em;
            color: #1976D2;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h2 {
            color: #6BAA5E;
            font-size: 1.5em;
            margin-bottom: 15px;
        }

        .shop-section {
            /* No bottom margin since it's in middle section */
        }

        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .shop-item {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFE8CC 100%);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #F7B32B;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .shop-item:hover:not(.shop-item-disabled) {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(247, 179, 43, 0.3);
        }

        .shop-item-disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .shop-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .shop-item-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .shop-item-price {
            font-size: 1.3em;
            font-weight: bold;
            color: #F7B32B;
        }

        .shop-item-description {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }

        .shop-item-owned {
            font-size: 0.85em;
            color: #6BAA5E;
            font-weight: bold;
        }

        .upgrades-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
            max-height: 600px;
            padding-right: 10px;
        }

        .upgrades-container::-webkit-scrollbar {
            width: 8px;
        }

        .upgrades-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .upgrades-container::-webkit-scrollbar-thumb {
            background: #6BAA5E;
            border-radius: 10px;
        }

        .upgrade-item {
            background: linear-gradient(135deg, #FFF8DC 0%, #E8F5E9 100%);
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .upgrade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .upgrade-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .upgrade-info {
            flex: 1;
        }

        .upgrade-name {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            margin-bottom: 3px;
        }

        .upgrade-description {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 3px;
        }

        .upgrade-owned {
            font-size: 0.8em;
            color: #6BAA5E;
            font-weight: bold;
        }

        .progress-bar-container {
            width: 100%;
            height: 22px;
            background: rgba(107, 170, 94, 0.2);
            border-radius: 11px;
            overflow: hidden;
            position: relative;
            margin-top: 8px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #6BAA5E 0%, #8BC34A 100%);
            border-radius: 12px;
            transition: width 0.1s linear;
            position: relative;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.85em;
            font-weight: bold;
            color: #333;
            text-shadow: 0 0 3px white;
            z-index: 1;
        }

        .production-rate {
            font-size: 0.85em;
            color: #F7B32B;
            font-weight: bold;
            margin-top: 3px;
        }

        .fishing-areas {
            margin-top: 10px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            border: 2px dashed #6BAA5E;
        }

        .fishing-areas-title {
            font-size: 0.95em;
            font-weight: bold;
            color: #6BAA5E;
            margin-bottom: 8px;
        }

        .fishing-area {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            border: 2px solid #E8F5E9;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .fishing-area-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fishing-area:last-child {
            margin-bottom: 0;
        }

        .area-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .area-text {
            min-width: 150px;
        }

        .area-name {
            font-weight: bold;
            color: #333;
            font-size: 0.9em;
            margin-bottom: 2px;
        }

        .area-fish-types {
            font-size: 0.75em;
            color: #666;
        }

        .area-progress-container {
            flex: 1;
            height: 20px;
            background: rgba(33, 150, 243, 0.15);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .area-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #2196F3 0%, #64B5F6 100%);
            border-radius: 10px;
            transition: width 0.1s linear;
        }

        .area-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.75em;
            font-weight: bold;
            color: #333;
            text-shadow: 0 0 3px white;
        }

        .area-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rod-count {
            font-size: 1em;
            font-weight: bold;
            color: #2196F3;
            min-width: 25px;
            text-align: center;
        }

        .area-button {
            background: #6BAA5E;
            color: white;
            border: none;
            border-radius: 5px;
            width: 26px;
            height: 26px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: background 0.2s;
        }

        .area-button:hover:not(:disabled) {
            background: #5A9A4E;
        }

        .area-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .unassigned-rods {
            font-size: 0.85em;
            color: #F7B32B;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .upgrade-cost {
            font-size: 1.3em;
            font-weight: bold;
            color: #F7B32B;
            white-space: nowrap;
            margin-left: 15px;
        }

        .reset-container {
            text-align: right;
            margin-bottom: 15px;
        }

        .reset-button {
            background: linear-gradient(135deg, #E57373 0%, #EF5350 100%);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(229, 115, 115, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .reset-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(229, 115, 115, 0.4);
        }

        .reset-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(229, 115, 115, 0.3);
        }

        .calendar-section {
            min-width: 240px;
            max-width: 240px;
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .calendar-header {
            text-align: center;
            margin-bottom: 6px;
        }

        .calendar-date {
            font-size: 1.1em;
            font-weight: bold;
            color: #2E7D32;
            margin-bottom: 1px;
        }

        .calendar-day {
            font-size: 0.75em;
            color: #558B2F;
        }

        .seasonal-fish {
            margin-top: 6px;
        }

        .seasonal-fish-title {
            font-size: 0.85em;
            font-weight: bold;
            color: #2E7D32;
            margin-bottom: 5px;
            text-align: center;
            border-bottom: 2px solid #81C784;
            padding-bottom: 3px;
        }

        .fish-location-group {
            margin-bottom: 6px;
        }

        .fish-location-name {
            font-size: 0.75em;
            font-weight: bold;
            color: #388E3C;
            margin-bottom: 3px;
        }

        .fish-list {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
        }

        .fish-tag {
            background: white;
            padding: 2px 5px;
            border-radius: 8px;
            font-size: 0.65em;
            color: #2E7D32;
            border: 1px solid #A5D6A7;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .fish-tag:hover {
            background: #E8F5E9;
            border-color: #66BB6A;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 10;
        }

        .fish-tooltip {
            position: fixed;
            background: white;
            border: 2px solid #66BB6A;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            min-width: 250px;
            pointer-events: none;
            display: none;
        }

        .fish-tooltip-content {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .fish-tooltip-image {
            width: 75px;
            height: 75px;
            object-fit: contain;
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            border-radius: 8px;
            flex-shrink: 0;
        }

        .fish-tooltip-image-placeholder {
            width: 75px;
            height: 75px;
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            flex-shrink: 0;
        }

        .fish-tooltip-details {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .fish-tooltip.show {
            display: block;
        }

        .fish-tooltip-name {
            font-size: 0.95em;
            font-weight: bold;
            color: #2E7D32;
            margin-bottom: 6px;
            border-bottom: 1px solid #A5D6A7;
            padding-bottom: 3px;
        }

        .fish-tooltip-info {
            font-size: 0.8em;
            color: #555;
            line-height: 1.5;
        }

        .fish-tooltip-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }

        .fish-tooltip-label {
            font-weight: bold;
            color: #388E3C;
        }

        .fish-tooltip-value {
            color: #666;
        }

        .no-fish {
            font-size: 0.75em;
            color: #757575;
            font-style: italic;
            text-align: center;
            padding: 8px;
        }

        .villagers-section {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #FFF9E6 0%, #FFE8B3 100%);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
        }

        .villagers-section.visible {
            display: block;
        }

        .villagers-title {
            font-size: 1em;
            font-weight: bold;
            color: #F7B32B;
            text-align: center;
            margin-bottom: 10px;
        }

        .villagers-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 8px;
        }

        .villager-slot {
            width: 60px;
            height: 60px;
            background: white;
            border: 2px solid #F7B32B;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .villager-slot.empty {
            background: rgba(255, 255, 255, 0.3);
            border-style: dashed;
        }

        .villager-portrait {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .villager-placeholder {
            font-size: 2em;
            color: #F7B32B;
        }

        .villager-name-tooltip {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7em;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 100;
        }

        .villager-slot:hover .villager-name-tooltip {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .game-container {
                padding: 20px;
            }

            h1 {
                font-size: 2em;
            }
            
            .villagers-section {
                position: static;
                transform: none;
                margin-top: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="top-section">
            <div class="right-sidebar">
                <div class="calendar-section">
                    <div class="calendar-header">
                        <div class="calendar-date" id="calendarDate">Jan 1</div>
                        <div class="calendar-day" id="calendarDay">Monday</div>
                    </div>
                    <div class="seasonal-fish">
                        <div class="seasonal-fish-title">üêü Fish in Season</div>
                        <div id="seasonalFishList">
                            <div class="no-fish">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="middle-section">
            <div class="shop-section-wrapper">
                <div class="shop-section">
                    <h2>üè™ Item Shop</h2>
                    <div class="shop-items" id="shopContainer">
                        <!-- Shop items will be dynamically added here -->
                    </div>
                </div>
            </div>
            <div class="main-header">
                <div class="reset-container">
                    <button class="reset-button" onclick="resetGame()">üîÑ Start Over</button>
                </div>
                <div class="header">
                    <h1>Island Idler</h1>
                    <div class="stats">
                        <div class="bell-count" id="bellCount">0 Bells</div>
                        <div class="per-second">Generating: <span id="perSecond">0</span> Bells/sec</div>
                        <div class="total-production" id="totalProduction">Total Earned: 0 Bells</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Fish tooltip -->
        <div class="fish-tooltip" id="fishTooltip">
            <div class="fish-tooltip-content" id="tooltipContent">
                <!-- Image and details will be inserted here -->
            </div>
        </div>

        <div>
            <h2>üèùÔ∏è Island Activities</h2>
            <div class="upgrades-container" id="upgradesContainer">
                <!-- Upgrades will be dynamically added here -->
            </div>
        </div>
    </div>

    <!-- Villagers Grid -->
    <div class="villagers-section" id="villagersSection">
        <div class="villagers-title">üèòÔ∏è Villagers</div>
        <div class="villagers-grid" id="villagersGrid">
            <!-- Villager slots will be dynamically added here -->
        </div>
    </div>

    <script>
        // Nookipedia API Configuration
        const NOOKIPEDIA_API_KEY = '8a10f688-39d6-40b8-8426-744f30542e94'; // Replace with your API key from https://api.nookipedia.com/
        const NOOKIPEDIA_API_URL = 'https://api.nookipedia.com/nh/fish';
        
        // Game state
        let bells = 300;
        let bellsPerSecond = 0;
        let totalBellsEarned = 0;
        let fishCache = [];
        let fishByLocation = {};
        let caughtFish = new Set(); // Track discovered/caught fish by name
        let villagersCache = []; // All available villagers from API
        let purchasedVillagers = []; // Villagers the player has bought
        let villagerCooldownEnd = 0; // Timestamp when villager can be purchased again
        let inventory = {
            fishingRod: 0
        };
        
        // Progress tracking for each upgrade
        const upgradeProgress = {};
        
        // Shop items - price will be updated from API
        let shopItems = [
            {
                id: 'fishingRod',
                name: 'üé£ Flimsy Fishing Rod',
                description: 'A basic fishing rod. Assign to fishing areas to start earning!',
                price: 400, // Default price, will be updated from Nookipedia API
                inventoryKey: 'fishingRod',
                maxPurchases: 1
            }
        ];
        
        // Fishing area progress tracking
        const fishingAreaProgress = {};
        const fishingAreaNextCatch = {}; // Stores the next catch time for each area
        
        // Fishing area allocations
        const fishingAreas = [
            {
                id: 'river',
                name: 'üèûÔ∏è River',
                description: 'Freshwater fish',
                fishTypes: ['River', 'Pond'],
                rods: 0
            },
            {
                id: 'ocean',
                name: 'üåä Ocean',
                description: 'Saltwater fish',
                fishTypes: ['Sea'],
                rods: 0
            },
            {
                id: 'pier',
                name: 'üé£ Pier',
                description: 'Large ocean fish',
                fishTypes: ['Pier'],
                rods: 0
            },
            {
                id: 'pond',
                name: 'ü¶Ü Pond',
                description: 'Small freshwater fish',
                fishTypes: ['Pond'],
                rods: 0
            }
        ];

        // Upgrade definitions with generation intervals
        const upgrades = [
            {
                id: 'villager',
                name: 'üê± Villager',
                description: 'A friendly villager who helps gather Bells',
                baseCost: 100,
                cps: 100,
                interval: 30,
                owned: 0,
                maxOwned: 10 // Cap at 10 villagers
            },
            {
                id: 'orchard',
                name: 'üå≥ Fruit Orchard',
                description: 'Grows fruit trees for steady income',
                baseCost: 1100,
                cps: 8,
                interval: 8,
                owned: 0
            },
            {
                id: 'shop',
                name: 'üè™ Nook\'s Cranny',
                description: 'A shop that generates passive income',
                baseCost: 12000,
                cps: 47,
                interval: 6,
                owned: 0
            },
            {
                id: 'museum',
                name: 'üèõÔ∏è Museum',
                description: 'Attracts tourists who donate Bells',
                baseCost: 130000,
                cps: 260,
                interval: 12,
                owned: 0
            },
            {
                id: 'island',
                name: 'üèùÔ∏è Mystery Island',
                description: 'Discover rare items and resources',
                baseCost: 1400000,
                cps: 1400,
                interval: 15,
                owned: 0
            },
            {
                id: 'nook',
                name: 'ü¶ù Tom Nook',
                description: 'The ultimate entrepreneur generates massive Bells',
                baseCost: 20000000,
                cps: 7800,
                interval: 10,
                owned: 0
            },
            {
                id: 'kk',
                name: 'üé∏ K.K. Slider Concert',
                description: 'Weekly concerts bring in huge crowds',
                baseCost: 330000000,
                cps: 44000,
                interval: 20,
                owned: 0
            }
        ];
        
        // Initialize progress for each upgrade
        upgrades.forEach(upgrade => {
            upgradeProgress[upgrade.id] = 0;
        });
        
        // Initialize fishing area progress
        fishingAreas.forEach(area => {
            fishingAreaProgress[area.id] = 0;
            // Random interval between 30-45 seconds
            fishingAreaNextCatch[area.id] = 30 + Math.random() * 15;
        });
        
        // Update calendar display
        function updateCalendar() {
            const now = new Date();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            const month = months[now.getMonth()];
            const date = now.getDate();
            const day = days[now.getDay()];
            
            calendarDateEl.textContent = `${month} ${date}`;
            calendarDayEl.textContent = day;
        }
        
        // Check if fish is available in current month (Northern Hemisphere)
        function isFishInSeason(fish) {
            if (!fish.north || !fish.north.months_array) return true; // If no data, assume available
            
            const currentMonth = new Date().getMonth() + 1; // 1-12
            return fish.north.months_array.includes(currentMonth);
        }
        
        // Show fish tooltip
        function showFishTooltip(event, fish) {
            const tooltip = document.getElementById('fishTooltip');
            const tooltipContent = document.getElementById('tooltipContent');
            
            if (!tooltip || !fish) return;
            
            let imageHTML = '';
            let detailsHTML = '';
            
            // Add fish image if available
            if (fish.image_url) {
                imageHTML = '<img src="' + fish.image_url + '" alt="' + fish.name + '" class="fish-tooltip-image" onerror="this.style.display=\'none\'">';
            } else {
                imageHTML = '<div class="fish-tooltip-image-placeholder">üêü</div>';
            }
            
            // Build details column
            detailsHTML += '<div class="fish-tooltip-details">';
            detailsHTML += '<div class="fish-tooltip-name">' + fish.name + '</div>';
            detailsHTML += '<div class="fish-tooltip-info">';
            
            if (fish.sell) {
                detailsHTML += `
                    <div class="fish-tooltip-row">
                        <span class="fish-tooltip-label">Sell Price:</span>
                        <span class="fish-tooltip-value">${fish.sell.toLocaleString()} Bells</span>
                    </div>
                `;
            }
            
            if (fish.size) {
                detailsHTML += `
                    <div class="fish-tooltip-row">
                        <span class="fish-tooltip-label">Size:</span>
                        <span class="fish-tooltip-value">${fish.size}</span>
                    </div>
                `;
            }
            
            if (fish.location) {
                detailsHTML += `
                    <div class="fish-tooltip-row">
                        <span class="fish-tooltip-label">Location:</span>
                        <span class="fish-tooltip-value">${fish.location}</span>
                    </div>
                `;
            }
            
            if (fish.north && fish.north.availability_array) {
                const times = fish.north.availability_array;
                const timeStr = times.length > 0 ? times.map(t => {
                    const start = t.time.split('-')[0];
                    const end = t.time.split('-')[1];
                    return `${start}-${end}`;
                }).join(', ') : 'All day';
                
                detailsHTML += `
                    <div class="fish-tooltip-row">
                        <span class="fish-tooltip-label">Time:</span>
                        <span class="fish-tooltip-value">${timeStr}</span>
                    </div>
                `;
            }
            
            detailsHTML += detailsHTML.includes('fish-tooltip-row') ? '' : '<div style="color: #999; font-style: italic; font-size: 0.75em;">No additional info</div>';
            detailsHTML += '</div>'; // Close fish-tooltip-info
            detailsHTML += '</div>'; // Close fish-tooltip-details
            
            // Combine image and details
            tooltipContent.innerHTML = imageHTML + detailsHTML;
            
            // Position tooltip near mouse
            const x = event.clientX + 15;
            const y = event.clientY + 15;
            
            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
            tooltip.classList.add('show');
        }
        
        // Hide fish tooltip
        function hideFishTooltip() {
            const tooltip = document.getElementById('fishTooltip');
            if (tooltip) {
                tooltip.classList.remove('show');
            }
        }
        
        // Update seasonal fish display
        function updateSeasonalFish() {
            if (fishCache.length === 0) {
                seasonalFishListEl.innerHTML = '<div class="no-fish">Loading fish data...</div>';
                return;
            }
            
            // Filter fish that are in season AND have been caught
            const seasonalFish = fishCache.filter(fish => 
                isFishInSeason(fish) && caughtFish.has(fish.name)
            );
            
            if (seasonalFish.length === 0) {
                seasonalFishListEl.innerHTML = '<div class="no-fish">No fish discovered yet</div>';
                return;
            }
            
            // Group by location
            const fishByLoc = {};
            seasonalFish.forEach(fish => {
                const loc = fish.location || 'Unknown';
                if (!fishByLoc[loc]) {
                    fishByLoc[loc] = [];
                }
                fishByLoc[loc].push(fish);
            });
            
            // Build HTML
            let html = '';
            const locationOrder = ['River', 'Pond', 'Sea', 'Pier', 'River (Clifftop)', 'River (Mouth)'];
            const locationIcons = {
                'River': 'üèûÔ∏è',
                'Pond': 'ü¶Ü',
                'Sea': 'üåä',
                'Pier': 'üé£',
                'River (Clifftop)': '‚õ∞Ô∏è',
                'River (Mouth)': 'üåä'
            };
            
            // Sort locations
            const sortedLocations = Object.keys(fishByLoc).sort((a, b) => {
                const aIndex = locationOrder.indexOf(a);
                const bIndex = locationOrder.indexOf(b);
                if (aIndex === -1 && bIndex === -1) return a.localeCompare(b);
                if (aIndex === -1) return 1;
                if (bIndex === -1) return -1;
                return aIndex - bIndex;
            });
            
            sortedLocations.forEach(location => {
                const fish = fishByLoc[location];
                const icon = locationIcons[location] || 'üìç';
                html += `
                    <div class="fish-location-group">
                        <div class="fish-location-name">${icon} ${location}</div>
                        <div class="fish-list">
                            ${fish.slice(0, 8).map(f => `
                                <div class="fish-tag" 
                                     onmouseenter="showFishTooltip(event, ${JSON.stringify(f).replace(/"/g, '&quot;')})" 
                                     onmouseleave="hideFishTooltip()">
                                    ${f.name}
                                </div>
                            `).join('')}
                            ${fish.length > 8 ? `<div class="fish-tag">+${fish.length - 8} more</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            seasonalFishListEl.innerHTML = html;
        }
        
        // Fetch item prices from Nookipedia API
        async function fetchItemPrices() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    console.log('Item price API request timed out');
                    controller.abort();
                }, 8000); // 8 second timeout for API
                
                const response = await fetch('https://api.nookipedia.com/nh/tools', {
                    method: 'GET',
                    headers: {
                        'X-API-KEY': NOOKIPEDIA_API_KEY,
                        'Accept-Version': '1.0.0'
                    },
                    signal: controller.signal,
                    mode: 'cors'
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const tools = await response.json();
                    const fishingRod = tools.find(tool => tool.name.toLowerCase().includes('flimsy fishing rod'));
                    
                    if (fishingRod) {
                        const rodItem = shopItems.find(item => item.id === 'fishingRod');
                        if (rodItem) {
                            // Handle different API response formats
                            let price = 400; // Default fallback
                            
                            if (typeof fishingRod.buy === 'number') {
                                price = fishingRod.buy;
                            } else if (fishingRod.buy && typeof fishingRod.buy === 'object' && fishingRod.buy.value) {
                                price = fishingRod.buy.value;
                            } else if (fishingRod.sell) {
                                price = typeof fishingRod.sell === 'number' ? fishingRod.sell : 500;
                            }
                            
                            rodItem.price = price;
                            // Update the display immediately
                            createShopItems();
                        }
                    }
                } else {
                    console.warn('Failed to fetch item prices:', response.status);
                }
            } catch (error) {
                console.warn('Could not fetch item prices from API:', error.message);
                console.log('Using default item prices');
            }
        }
        
        // Initialize fallback data immediately
        function initializeFallbackData() {
            fishCache = [
                { name: 'Sea Bass', sell: 400, size: 'Large', location: 'Sea' },
                { name: 'Red Snapper', sell: 3000, size: 'Large', location: 'Sea' },
                { name: 'Dab', sell: 300, size: 'Medium', location: 'Sea' },
                { name: 'Olive Flounder', sell: 800, size: 'Large', location: 'Sea' },
                { name: 'Squid', sell: 500, size: 'Medium', location: 'Sea' },
                { name: 'Coelacanth', sell: 15000, size: 'Huge', location: 'Sea' },
                { name: 'Oarfish', sell: 9000, size: 'Huge', location: 'Pier' },
                { name: 'Tuna', sell: 7000, size: 'Huge', location: 'Pier' },
                { name: 'Blue Marlin', sell: 10000, size: 'Huge', location: 'Pier' },
                { name: 'Koi', sell: 4000, size: 'Large', location: 'River' },
                { name: 'Goldfish', sell: 1300, size: 'Tiny', location: 'Pond' },
                { name: 'Bitterling', sell: 900, size: 'Tiny', location: 'River' },
                { name: 'Pale Chub', sell: 200, size: 'Tiny', location: 'River' }
            ];
            
            // Organize fish by location
            fishByLocation = {};
            fishCache.forEach(fish => {
                const loc = fish.location;
                if (!fishByLocation[loc]) {
                    fishByLocation[loc] = [];
                }
                fishByLocation[loc].push(fish);
            });
            
            updateSeasonalFish();
        }
        
        // Fetch API data in background
        async function fetchAPIDataInBackground() {
            // Fetch all in parallel
            const itemPricesPromise = fetchItemPrices();
            const fishDataPromise = fetchFishData();
            const villagersDataPromise = fetchVillagersFromAPI();
            
            await Promise.all([itemPricesPromise, fishDataPromise, villagersDataPromise]);
            
            // Update UI after API data loads
            createShopItems();
            updateSeasonalFish();
        }
        
        // Fetch fish data from Nookipedia API
        async function fetchFishData() {
            if (NOOKIPEDIA_API_KEY === 'YOUR_API_KEY_HERE') {
                console.warn('Nookipedia API key not set. Using fallback fish data.');
                return;
            }
            
            // Fallback data already loaded, just try to fetch from API
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    console.log('API request timed out after 8 seconds');
                    controller.abort();
                }, 8000); // 8 second timeout
                
                const response = await fetch(NOOKIPEDIA_API_URL, {
                    method: 'GET',
                    headers: {
                        'X-API-KEY': NOOKIPEDIA_API_KEY,
                        'Accept-Version': '1.0.0'
                    },
                    signal: controller.signal,
                    mode: 'cors'
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const rawFish = await response.json();
                    // Normalize fish data from API
                    const apiFishCache = rawFish.map(fish => ({
                        name: fish.name,
                        sell: fish.sell_nook || fish.sell || 400,
                        size: fish.shadow_size || fish.size || 'Medium',
                        location: fish.location || 'Sea',
                        north: fish.north,
                        image_url: fish.image_url || fish.render_url || null
                    }));
                    
                    // Only update if we got valid data
                    if (apiFishCache.length > 0) {
                        fishCache = apiFishCache;
                        
                        // Organize fish by location
                        fishByLocation = {};
                        fishCache.forEach(fish => {
                            const loc = fish.location;
                            if (!fishByLocation[loc]) {
                                fishByLocation[loc] = [];
                            }
                            fishByLocation[loc].push(fish);
                        });
                        
                        console.log(`üêü Loaded ${fishCache.length} fish from API`);
                    }
                } else {
                    // Failed to fetch fish data, using fallback
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.warn('Fish API request timed out - keeping fallback data');
                } else {
                    console.warn('Error fetching fish data:', error.name, error.message);
                }
                // Fallback data already loaded, no need to reload
            }
        }
        
        // Fetch villagers from Nookipedia API
        // Note: Villagers endpoint blocked by CORS - using curated fallback data
        async function fetchVillagersFromAPI() {
            // Load fallback villagers (curated list of popular villagers)
            if (villagersCache.length === 0) {
                villagersCache = [
                    { name: 'Bob', species: 'Cat', personality: 'Lazy', image_url: null },
                    { name: 'Rosie', species: 'Cat', personality: 'Peppy', image_url: null },
                    { name: 'Marshal', species: 'Squirrel', personality: 'Smug', image_url: null },
                    { name: 'Raymond', species: 'Cat', personality: 'Smug', image_url: null },
                    { name: 'Ankha', species: 'Cat', personality: 'Snooty', image_url: null },
                    { name: 'Stitches', species: 'Cub', personality: 'Lazy', image_url: null },
                    { name: 'Fauna', species: 'Deer', personality: 'Normal', image_url: null },
                    { name: 'Zucker', species: 'Octopus', personality: 'Lazy', image_url: null },
                    { name: 'Judy', species: 'Cub', personality: 'Snooty', image_url: null },
                    { name: 'Sherb', species: 'Goat', personality: 'Lazy', image_url: null },
                    { name: 'Audie', species: 'Wolf', personality: 'Peppy', image_url: null },
                    { name: 'Dom', species: 'Sheep', personality: 'Jock', image_url: null },
                    { name: 'Molly', species: 'Duck', personality: 'Normal', image_url: null },
                    { name: 'Marina', species: 'Octopus', personality: 'Normal', image_url: null },
                    { name: 'Merengue', species: 'Rhino', personality: 'Normal', image_url: null },
                    { name: 'Coco', species: 'Rabbit', personality: 'Normal', image_url: null },
                    { name: 'Lucky', species: 'Dog', personality: 'Lazy', image_url: null },
                    { name: 'Maple', species: 'Cub', personality: 'Normal', image_url: null },
                    { name: 'Lolly', species: 'Cat', personality: 'Normal', image_url: null },
                    { name: 'Tangy', species: 'Cat', personality: 'Peppy', image_url: null }
                ];
            }
            // API endpoint doesn't support CORS from browsers, so we use fallback data only
        }
        
        // Initialize villagers grid
        function initVillagersGrid() {
            const grid = document.getElementById('villagersGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                const slot = document.createElement('div');
                slot.className = 'villager-slot empty';
                slot.id = `villager-slot-${i}`;
                grid.appendChild(slot);
            }
        }
        
        // Update villagers grid display
        function updateVillagersGrid() {
            const section = document.getElementById('villagersSection');
            const grid = document.getElementById('villagersGrid');
            
            if (!section || !grid) return;
            
            // Show section if we have villagers
            if (purchasedVillagers.length > 0) {
                section.classList.add('visible');
            } else {
                section.classList.remove('visible');
                return;
            }
            
            // Update each slot
            for (let i = 0; i < 10; i++) {
                const slot = document.getElementById(`villager-slot-${i}`);
                if (!slot) continue;
                
                if (i < purchasedVillagers.length) {
                    const villager = purchasedVillagers[i];
                    slot.className = 'villager-slot';
                    const imageHtml = villager.image_url ? `<img src="${villager.image_url}" alt="${villager.name}" class="villager-portrait" onerror="this.style.display='none'">` : '<div class="villager-placeholder">üë§</div>';
                    slot.innerHTML = `
                        ${imageHtml}
                        <div class="villager-name-tooltip">${villager.name}</div>
                    `;
                } else {
                    slot.className = 'villager-slot empty';
                    slot.innerHTML = '';
                }
            }
        }
        
        // Get random villager that hasn't been purchased yet
        function getRandomVillager() {
            if (villagersCache.length === 0) {
                // Fallback if API hasn't loaded
                return {
                    name: 'Villager ' + (purchasedVillagers.length + 1),
                    image_url: null,
                    species: 'Unknown',
                    personality: 'Unknown'
                };
            }
            
            // Filter out already purchased villagers
            const purchasedNames = new Set(purchasedVillagers.map(v => v.name));
            const availableVillagers = villagersCache.filter(v => !purchasedNames.has(v.name));
            
            if (availableVillagers.length === 0) {
                // All villagers purchased, pick any random one
                return villagersCache[Math.floor(Math.random() * villagersCache.length)];
            }
            
            return availableVillagers[Math.floor(Math.random() * availableVillagers.length)];
        }
        
        // Display fish catch message
        function showFishMessage(fish) {
            const fishingUpgrade = document.getElementById('upgrade-fishing');
            if (!fishingUpgrade) return;
            
            // Remove any existing fish message
            const existingMessage = fishingUpgrade.querySelector('.fish-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            const sellPrice = fish.sell || fish.sell_nook || 400;
            const fishSize = fish.size || fish.shadow_size || 'Medium';
            
            const message = document.createElement('div');
            message.className = 'fish-message';
            message.innerHTML = `
                <div><strong>üé£ Caught a ${fish.name}!</strong></div>
                <div class="fish-details">Size: ${fishSize} | Sold for: ${sellPrice.toLocaleString()} Bells</div>
            `;
            
            // Insert at the beginning (after the upgrade-header)
            const upgradeHeader = fishingUpgrade.querySelector('.upgrade-header');
            if (upgradeHeader && upgradeHeader.nextSibling) {
                fishingUpgrade.insertBefore(message, upgradeHeader.nextSibling);
            } else {
                fishingUpgrade.appendChild(message);
            }
            
            // Remove message after 5 seconds
            setTimeout(() => {
                if (message.parentNode) {
                    message.style.animation = 'slideIn 0.3s ease-out reverse';
                    setTimeout(() => message.remove(), 300);
                }
            }, 5000);
        }
        
        // Get random fish from specific area with rarity-based weighting
        function getRandomFishFromArea(area) {
            let availableFish = [];
            
            // Get fish matching this area's types
            area.fishTypes.forEach(type => {
                if (fishByLocation[type]) {
                    availableFish = availableFish.concat(fishByLocation[type]);
                }
            });
            
            // Fallback to all fish if no matches
            if (availableFish.length === 0) {
                availableFish = fishCache;
            }
            
            if (availableFish.length === 0) return null;
            
            // Calculate weights based on rarity (inverse of price)
            // Lower price = higher weight (more common)
            // Higher price = lower weight (more rare)
            const weights = availableFish.map(fish => {
                const price = fish.sell || 400;
                // Use inverse square root for more gradual rarity scaling
                // Common fish (200-500): weight ~0.045-0.071
                // Uncommon (1000-3000): weight ~0.018-0.032
                // Rare (5000-10000): weight ~0.010-0.014
                // Ultra rare (15000+): weight ~0.008
                return 1 / Math.sqrt(price);
            });
            
            // Calculate total weight
            const totalWeight = weights.reduce((sum, w) => sum + w, 0);
            
            // Random selection based on weights
            let random = Math.random() * totalWeight;
            for (let i = 0; i < availableFish.length; i++) {
                random -= weights[i];
                if (random <= 0) {
                    return availableFish[i];
                }
            }
            
            // Fallback (shouldn't reach here)
            return availableFish[availableFish.length - 1];
        }
        
        // Allocate rod to area
        function allocateRod(areaId, amount) {
            const area = fishingAreas.find(a => a.id === areaId);
            if (!area) return;
            
            const totalAssigned = fishingAreas.reduce((sum, a) => sum + a.rods, 0);
            const unassigned = inventory.fishingRod - totalAssigned;
            
            if (amount > 0 && unassigned >= amount) {
                area.rods += amount;
            } else if (amount < 0 && area.rods >= Math.abs(amount)) {
                area.rods += amount; // amount is negative
            }
            
            updateFishingAreasUI();
        }
        
        // Update fishing areas UI
        function updateFishingAreasUI() {
            const container = document.getElementById('fishing-areas-container');
            if (!container) return;
            
            const totalAssigned = fishingAreas.reduce((sum, a) => sum + a.rods, 0);
            const unassigned = inventory.fishingRod - totalAssigned;
            
            if (inventory.fishingRod === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            const unassignedEl = document.getElementById('unassigned-rods');
            if (unassignedEl) {
                unassignedEl.textContent = `Unassigned Rods: ${unassigned}`;
            }
            
            fishingAreas.forEach(area => {
                const rodCountEl = document.getElementById(`rod-count-${area.id}`);
                const addBtn = document.getElementById(`add-rod-${area.id}`);
                const removeBtn = document.getElementById(`remove-rod-${area.id}`);
                
                if (rodCountEl) rodCountEl.textContent = area.rods;
                if (addBtn) addBtn.disabled = unassigned === 0;
                if (removeBtn) removeBtn.disabled = area.rods === 0;
            });
        }

        // DOM elements - will be initialized after DOM loads
        let bellCountEl, perSecondEl, totalProductionEl, upgradesContainer, shopContainer;
        let calendarDateEl, calendarDayEl, seasonalFishListEl;
        
        // Initialize DOM elements
        function initDOMElements() {
            bellCountEl = document.getElementById('bellCount');
            perSecondEl = document.getElementById('perSecond');
            totalProductionEl = document.getElementById('totalProduction');
            upgradesContainer = document.getElementById('upgradesContainer');
            shopContainer = document.getElementById('shopContainer');
            calendarDateEl = document.getElementById('calendarDate');
            calendarDayEl = document.getElementById('calendarDay');
            seasonalFishListEl = document.getElementById('seasonalFishList');
        }

        // Calculate upgrade cost with scaling
        function getUpgradeCost(upgrade) {
            // Villagers always cost 100 bells (no scaling)
            if (upgrade.id === 'villager') {
                return upgrade.baseCost;
            }
            return Math.floor(upgrade.baseCost * Math.pow(1.15, upgrade.owned));
        }

        // Format numbers
        function formatNumber(num) {
            if (num >= 1000000000) return (num / 1000000000).toFixed(2) + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(2) + 'K';
            return Math.floor(num).toString();
        }

        // Update display
        function updateDisplay() {
            bellCountEl.textContent = formatNumber(bells) + ' Bells';
            perSecondEl.textContent = formatNumber(bellsPerSecond);
            totalProductionEl.textContent = 'Total Earned: ' + formatNumber(totalBellsEarned) + ' Bells';
            updateUpgradeButtons();
            updateShopItems();
        }

        // Create shop items
        function createShopItems() {
            shopContainer.innerHTML = '';
            shopItems.forEach(item => {
                // Ensure price is a number
                if (typeof item.price !== 'number') {
                    console.warn(`Invalid price for ${item.name}, resetting to 500`);
                    item.price = 500;
                }
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shop-item';
                itemDiv.id = `shop-${item.id}`;
                
                itemDiv.innerHTML = `
                    <div class="shop-item-header">
                        <div class="shop-item-name">${item.name}</div>
                        <div class="shop-item-price" id="shop-price-${item.id}">${formatNumber(item.price)} Bells</div>
                    </div>
                    <div class="shop-item-description">${item.description}</div>
                    <div class="shop-item-owned">Owned: <span id="shop-owned-${item.id}">0</span></div>
                `;
                
                itemDiv.addEventListener('click', () => buyShopItem(item));
                shopContainer.appendChild(itemDiv);
            });
        }
        
        // Update shop items UI
        function updateShopItems() {
            shopItems.forEach(item => {
                const itemDiv = document.getElementById(`shop-${item.id}`);
                const ownedEl = document.getElementById(`shop-owned-${item.id}`);
                
                if (ownedEl) {
                    ownedEl.textContent = inventory[item.inventoryKey] || 0;
                }
                
                if (itemDiv) {
                    const owned = inventory[item.inventoryKey] || 0;
                    const maxReached = item.maxPurchases && owned >= item.maxPurchases;
                    
                    if (maxReached) {
                        itemDiv.classList.add('shop-item-disabled');
                        itemDiv.style.opacity = '0.5';
                        itemDiv.style.cursor = 'not-allowed';
                    } else if (bells >= item.price) {
                        itemDiv.classList.remove('shop-item-disabled');
                        itemDiv.style.opacity = '1';
                        itemDiv.style.cursor = 'pointer';
                    } else {
                        itemDiv.classList.add('shop-item-disabled');
                        itemDiv.style.opacity = '1';
                        itemDiv.style.cursor = 'pointer';
                    }
                }
            });
        }
        
        // Buy shop item
        function buyShopItem(item) {
            const owned = inventory[item.inventoryKey] || 0;
            
            // Check if max purchases reached
            if (item.maxPurchases && owned >= item.maxPurchases) {
                console.log(`Cannot buy more ${item.name} - maximum reached`);
                return;
            }
            
            if (bells >= item.price) {
                bells -= item.price;
                inventory[item.inventoryKey]++;
                updateDisplay();
                updateShopItems();
                updateFishingAreasUI();
            }
        }
        
        // Create upgrade buttons
        function createUpgradeButtons() {
            upgradesContainer.innerHTML = '';
            
            // Create fishing areas card
            const fishingDiv = document.createElement('div');
            fishingDiv.className = 'upgrade-item';
            fishingDiv.id = 'upgrade-fishing';
            
            fishingDiv.innerHTML = `
                <div class="upgrade-header">
                    <div class="upgrade-info">
                        <div class="upgrade-name">üé£ Fishing Areas</div>
                        <div class="upgrade-description">Assign your fishing rods to different areas</div>
                    </div>
                </div>
                <div class="fishing-areas" id="fishing-areas-container" style="display: none;">
                    <div class="fishing-areas-title">Fishing Areas</div>
                    <div class="unassigned-rods" id="unassigned-rods">Unassigned Rods: 0</div>
                    ${fishingAreas.map(area => `
                        <div class="fishing-area">
                            <div class="fishing-area-top">
                                <div class="area-info">
                                    <div class="area-text">
                                        <div class="area-name">${area.name}</div>
                                        <div class="area-fish-types">${area.description}</div>
                                    </div>
                                    <div class="area-progress-container">
                                        <div class="area-progress-text" id="area-progress-text-${area.id}">0%</div>
                                        <div class="area-progress-bar" id="area-progress-bar-${area.id}" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div class="area-controls">
                                    <button class="area-button" id="remove-rod-${area.id}" onclick="allocateRod('${area.id}', -1)">-</button>
                                    <div class="rod-count" id="rod-count-${area.id}">0</div>
                                    <button class="area-button" id="add-rod-${area.id}" onclick="allocateRod('${area.id}', 1)">+</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            upgradesContainer.appendChild(fishingDiv);
            
            // Add other upgrades
            upgrades.forEach(upgrade => {
                const upgradeDiv = document.createElement('div');
                upgradeDiv.className = 'upgrade-item';
                upgradeDiv.id = `upgrade-${upgrade.id}`;
                
                const cost = getUpgradeCost(upgrade);
                const cooldownHtml = upgrade.id === 'villager' ? `<div class="villager-cooldown" id="cooldown-${upgrade.id}" style="display: none; color: #F7B32B; font-size: 0.9em; margin-top: 5px;"></div>` : '';
                
                upgradeDiv.innerHTML = `
                    <div class="upgrade-header">
                        <div class="upgrade-info">
                            <div class="upgrade-name">${upgrade.name}</div>
                            <div class="upgrade-description">${upgrade.description}</div>
                            <div class="upgrade-owned">Owned: <span id="owned-${upgrade.id}">0</span></div>
                            <div class="production-rate" id="production-${upgrade.id}">Generates: 0 Bells/${upgrade.interval}s</div>
                            ${cooldownHtml}
                        </div>
                        <div class="upgrade-cost" id="cost-${upgrade.id}">${formatNumber(cost)} üîî</div>
                    </div>
                    <div class="progress-bar-container" id="progress-container-${upgrade.id}" style="display: none;">
                        <div class="progress-text" id="progress-text-${upgrade.id}">0%</div>
                        <div class="progress-bar" id="progress-bar-${upgrade.id}" style="width: 0%"></div>
                    </div>
                `;
                
                upgradeDiv.addEventListener('click', () => buyUpgrade(upgrade));
                upgradesContainer.appendChild(upgradeDiv);
            });
        }

        // Update upgrade button states
        function updateUpgradeButtons() {
            upgrades.forEach(upgrade => {
                const cost = getUpgradeCost(upgrade);
                const upgradeDiv = document.getElementById(`upgrade-${upgrade.id}`);
                const costEl = document.getElementById(`cost-${upgrade.id}`);
                const ownedEl = document.getElementById(`owned-${upgrade.id}`);
                const productionEl = document.getElementById(`production-${upgrade.id}`);
                const progressContainer = document.getElementById(`progress-container-${upgrade.id}`);
                const cooldownEl = document.getElementById(`cooldown-${upgrade.id}`);
                
                // Check if max owned limit reached
                const maxReached = upgrade.maxOwned && upgrade.owned >= upgrade.maxOwned;
                
                // Check villager cooldown
                const onCooldown = upgrade.id === 'villager' && isVillagerOnCooldown();
                
                if (upgradeDiv) {
                    if (maxReached || onCooldown) {
                        upgradeDiv.classList.add('disabled');
                    } else if (bells >= cost) {
                        upgradeDiv.classList.remove('disabled');
                    } else {
                        upgradeDiv.classList.add('disabled');
                    }
                }
                
                // Update cooldown display for villager
                if (cooldownEl) {
                    if (onCooldown) {
                        const remaining = formatCooldownTime(getRemainingCooldown());
                        cooldownEl.textContent = `‚è∞ Next villager in: ${remaining}`;
                        cooldownEl.style.display = 'block';
                    } else {
                        cooldownEl.style.display = 'none';
                    }
                }
                
                if (costEl) {
                    if (maxReached) {
                        costEl.textContent = 'MAX';
                    } else {
                        costEl.textContent = formatNumber(cost) + ' üîî';
                    }
                }
                
                if (ownedEl) {
                    if (upgrade.maxOwned) {
                        ownedEl.textContent = `${upgrade.owned}/${upgrade.maxOwned}`;
                    } else {
                        ownedEl.textContent = upgrade.owned;
                    }
                }
                
                // Show/hide progress bar based on ownership
                if (progressContainer) {
                    if (upgrade.owned > 0) {
                        progressContainer.style.display = 'block';
                        const bellsPerInterval = upgrade.cps * upgrade.owned;
                        if (productionEl) {
                            productionEl.textContent = `Generates: ${formatNumber(bellsPerInterval)} Bells/${upgrade.interval}s`;
                        }
                    } else {
                        progressContainer.style.display = 'none';
                        if (productionEl) {
                            productionEl.textContent = `Generates: ${formatNumber(upgrade.cps)} Bells/${upgrade.interval}s each`;
                        }
                    }
                }
            });
        }
        
        // Update progress bars
        function updateProgressBars() {
            upgrades.forEach(upgrade => {
                if (upgrade.owned > 0) {
                    const progressBar = document.getElementById(`progress-bar-${upgrade.id}`);
                    const progressText = document.getElementById(`progress-text-${upgrade.id}`);
                    
                    if (progressBar && progressText) {
                        const progress = upgradeProgress[upgrade.id];
                        const percentage = (progress / upgrade.interval) * 100;
                        progressBar.style.width = percentage + '%';
                        progressText.textContent = Math.floor(percentage) + '%';
                    }
                }
            });
            
            // Update fishing area progress bars
            fishingAreas.forEach(area => {
                if (area.rods > 0) {
                    const progressBar = document.getElementById(`area-progress-bar-${area.id}`);
                    const progressText = document.getElementById(`area-progress-text-${area.id}`);
                    
                    if (progressBar && progressText) {
                        const progress = fishingAreaProgress[area.id];
                        const nextCatch = fishingAreaNextCatch[area.id];
                        const percentage = (progress / nextCatch) * 100; // Variable interval (30-45s)
                        progressBar.style.width = percentage + '%';
                        progressText.textContent = Math.floor(percentage) + '%';
                    }
                }
            });
        }

        // Check if villager cooldown is active
        function isVillagerOnCooldown() {
            return Date.now() < villagerCooldownEnd;
        }
        
        // Get remaining cooldown time in milliseconds
        function getRemainingCooldown() {
            return Math.max(0, villagerCooldownEnd - Date.now());
        }
        
        // Format cooldown time for display
        function formatCooldownTime(ms) {
            const hours = Math.floor(ms / (1000 * 60 * 60));
            const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((ms % (1000 * 60)) / 1000);
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds}s`;
            } else {
                return `${seconds}s`;
            }
        }
        
        // Buy upgrade
        function buyUpgrade(upgrade) {
            // Check if max owned limit reached
            if (upgrade.maxOwned && upgrade.owned >= upgrade.maxOwned) {
                return;
            }
            
            // Check villager cooldown
            if (upgrade.id === 'villager' && isVillagerOnCooldown()) {
                const remaining = formatCooldownTime(getRemainingCooldown());
                alert(`‚è∞ You can invite another villager in ${remaining}`);
                return;
            }
            
            const cost = getUpgradeCost(upgrade);
            if (bells >= cost) {
                bells -= cost;
                upgrade.owned++;
                
                // If buying a villager, add a random villager to the grid and set cooldown
                if (upgrade.id === 'villager') {
                    const newVillager = getRandomVillager();
                    purchasedVillagers.push(newVillager);
                    updateVillagersGrid();
                    
                    // Set 24-hour cooldown (24 * 60 * 60 * 1000 ms)
                    villagerCooldownEnd = Date.now() + (24 * 60 * 60 * 1000);
                }
                
                calculateCPS();
                updateDisplay();
            }
        }

        // Calculate Bells per second
        function calculateCPS() {
            bellsPerSecond = 0;
            upgrades.forEach(upgrade => {
                // cps represents bells per interval, so divide by interval to get per second
                bellsPerSecond += (upgrade.cps / upgrade.interval) * upgrade.owned;
            });
        }


        // Game loop - runs every 100ms (0.1 seconds)
        setInterval(() => {
            const deltaTime = 0.1; // 100ms in seconds
            
            // Update progress for each owned upgrade
            upgrades.forEach(upgrade => {
                if (upgrade.owned > 0) {
                    upgradeProgress[upgrade.id] += deltaTime;
                    
                    // Check if interval completed
                    if (upgradeProgress[upgrade.id] >= upgrade.interval) {
                        const cycles = Math.floor(upgradeProgress[upgrade.id] / upgrade.interval);
                        const bellsGenerated = upgrade.cps * upgrade.owned * cycles;
                        bells += bellsGenerated;
                        totalBellsEarned += bellsGenerated;
                        upgradeProgress[upgrade.id] %= upgrade.interval;
                        
                    }
                }
            });
            
            updateDisplay();
            updateProgressBars();
        }, 100);
        
        // Fishing loop - runs every 100ms
        setInterval(() => {
            if (fishCache.length === 0) return;
            
            const deltaTime = 0.1; // 100ms in seconds
            
            // Update progress for each fishing area with assigned rods
            fishingAreas.forEach(area => {
                if (area.rods > 0) {
                    fishingAreaProgress[area.id] += deltaTime;
                    
                    // Check if variable interval completed (30-45 seconds)
                    if (fishingAreaProgress[area.id] >= fishingAreaNextCatch[area.id]) {
                        const fish = getRandomFishFromArea(area);
                        if (fish) {
                            // Add fish to caught list if not already there
                            if (!caughtFish.has(fish.name)) {
                                caughtFish.add(fish.name);
                                updateSeasonalFish(); // Update calendar when new fish is discovered
                            }
                            
                            // Add fish sell price to bells (per rod in this area)
                            const fishValue = fish.sell || 0;
                            bells += fishValue * area.rods;
                            totalBellsEarned += fishValue * area.rods;
                            showFishMessage(fish);
                        }
                        fishingAreaProgress[area.id] = 0;
                        // Set new random interval between 30-45 seconds
                        fishingAreaNextCatch[area.id] = 30 + Math.random() * 15;
                    }
                }
            });
        }, 100);

        // Save game every 5 seconds
        setInterval(() => {
            const gameState = {
                bells,
                totalBellsEarned,
                upgrades: upgrades.map(u => ({ id: u.id, owned: u.owned })),
                progress: upgradeProgress,
                fishingAreas: fishingAreas.map(a => ({ id: a.id, rods: a.rods })),
                fishingAreaProgress,
                fishingAreaNextCatch,
                inventory,
                caughtFish: Array.from(caughtFish), // Convert Set to Array for JSON
                purchasedVillagers,
                villagerCooldownEnd
            };
            localStorage.setItem('animalCrossingBellsSave', JSON.stringify(gameState));
        }, 5000);

        // Load game
        function loadGame() {
            const saved = localStorage.getItem('animalCrossingBellsSave');
            if (saved) {
                const gameState = JSON.parse(saved);
                bells = gameState.bells || 0;
                totalBellsEarned = gameState.totalBellsEarned || 0;
                if (gameState.upgrades) {
                    gameState.upgrades.forEach(savedUpgrade => {
                        const upgrade = upgrades.find(u => u.id === savedUpgrade.id);
                        if (upgrade) {
                            upgrade.owned = savedUpgrade.owned;
                        }
                    });
                }
                if (gameState.progress) {
                    Object.assign(upgradeProgress, gameState.progress);
                }
                if (gameState.fishingAreas) {
                    gameState.fishingAreas.forEach(savedArea => {
                        const area = fishingAreas.find(a => a.id === savedArea.id);
                        if (area) {
                            area.rods = savedArea.rods;
                        }
                    });
                }
                if (gameState.inventory) {
                    Object.assign(inventory, gameState.inventory);
                }
                if (gameState.fishingAreaProgress) {
                    Object.assign(fishingAreaProgress, gameState.fishingAreaProgress);
                }
                if (gameState.fishingAreaNextCatch) {
                    Object.assign(fishingAreaNextCatch, gameState.fishingAreaNextCatch);
                }
                if (gameState.caughtFish) {
                    caughtFish = new Set(gameState.caughtFish); // Convert Array back to Set
                }
                if (gameState.purchasedVillagers) {
                    purchasedVillagers = gameState.purchasedVillagers;
                }
                if (gameState.villagerCooldownEnd) {
                    villagerCooldownEnd = gameState.villagerCooldownEnd;
                }
                calculateCPS();
            }
        }

        // Reset game
        function resetGame() {
            if (confirm('Are you sure you want to start over? This will delete all your progress!')) {
                localStorage.removeItem('animalCrossingBellsSave');
                location.reload();
            }
        }

        // Initialize game
        async function initGame() {
            try {
                console.log('üèùÔ∏è Initializing Island Idler...');
                initDOMElements();
                
                // Verify DOM elements loaded
                if (!shopContainer || !upgradesContainer) {
                    console.error('‚ùå DOM elements not found!', {
                        shopContainer,
                        upgradesContainer,
                        bellCountEl
                    });
                    return;
                }
                
                // Initialize with fallback data immediately
                initializeFallbackData();
                updateCalendar();
                loadGame();
                
                // Setup UI
                createShopItems();
                createUpgradeButtons();
                updateDisplay();
                updateFishingAreasUI();
                initVillagersGrid();
                updateVillagersGrid();
                
                // Fetch API data in background (non-blocking)
                fetchAPIDataInBackground();
                
                // Update calendar every minute
                setInterval(updateCalendar, 60000);
                
                console.log('‚úÖ Game initialized successfully!');
            } catch (error) {
                console.error('Error initializing game:', error);
            }
        }
        
        // Wait for DOM to be fully loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initGame);
        } else {
            // DOM is already ready, init immediately
            initGame();
        }
    </script>
</body>
</html>
